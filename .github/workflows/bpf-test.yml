name: BPF Comparison Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  bpf-tests:
    name: Run BPF Comparison Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install tcpdump
        run: |
          sudo apt-get update
          sudo apt-get install -y tcpdump

      - name: Verify tcpdump
        run: |
          tcpdump --version
          which tcpdump

      - name: Build backend
        run: |
          cd backend
          go mod download
          go build -o bin/server ./cmd/server

      - name: Start server
        run: |
          cd backend
          PORT=8085 ./bin/server &
          sleep 3
          curl -s http://localhost:8085/api/v1/bpf/antrea/status | jq '.'

      - name: Run BPF Test Suite
        run: |
          echo "=== Running BPF Comparison Test Suite ==="
          
          # Get test categories
          curl -s http://localhost:8085/api/v1/bpf/testgen/categories | jq '.'
          
          # Run full test suite
          RESULT=$(curl -s -X POST http://localhost:8085/api/v1/bpf/testgen/run \
            -H "Content-Type: application/json" \
            -d '{}')
          
          echo "$RESULT" | jq '.'
          
          # Extract pass rate
          PASS_RATE=$(echo "$RESULT" | jq '.passRate')
          TOTAL=$(echo "$RESULT" | jq '.total')
          PASSED=$(echo "$RESULT" | jq '.passed')
          FAILED=$(echo "$RESULT" | jq '.failed')
          
          echo "=========================="
          echo "Total: $TOTAL"
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"
          echo "Pass Rate: $PASS_RATE%"
          echo "=========================="
          
          # Fail if pass rate is below 95%
          if (( $(echo "$PASS_RATE < 95" | bc -l) )); then
            echo "FAIL: Pass rate below 95%"
            exit 1
          fi

      - name: Test Individual Categories
        run: |
          for category in tcp udp protocol kubernetes antrea; do
            echo "=== Testing category: $category ==="
            curl -s -X POST http://localhost:8085/api/v1/bpf/testgen/run \
              -H "Content-Type: application/json" \
              -d "{\"categories\":[\"$category\"]}" | jq '{category: "'$category'", passed, total, passRate}'
          done

      - name: Generate Go Test File
        run: |
          mkdir -p test-output
          curl -s -X POST http://localhost:8085/api/v1/bpf/testgen/go-test \
            -H "Content-Type: application/json" \
            -d '{"packageName":"capture"}' | jq -r '.code' > test-output/bpf_generated_test.go
          
          echo "Generated test file:"
          head -50 test-output/bpf_generated_test.go

      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bpf-test-output
          path: test-output/

      - name: Validate Generated Go Test
        run: |
          cd test-output
          # Check that the generated file has valid Go syntax
          go fmt bpf_generated_test.go
          echo "Go test file is valid"

  semantic-analysis:
    name: Semantic Equivalence Analysis
    runs-on: ubuntu-latest
    needs: bpf-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install tcpdump
        run: sudo apt-get update && sudo apt-get install -y tcpdump

      - name: Build and Start Server
        run: |
          cd backend
          go build -o bin/server ./cmd/server
          PORT=8085 ./bin/server &
          sleep 3

      - name: Run Semantic Analysis
        run: |
          echo "=== Semantic Equivalence Analysis ==="
          
          # Test semantic equivalence detection
          echo "--- Test 1: Port Equivalence ---"
          curl -s -X POST http://localhost:8085/api/v1/bpf/semantic/analyze \
            -H "Content-Type: application/json" \
            -d '{"expression1": "tcp port 80", "expression2": "tcp dst port 80 or tcp src port 80"}' | jq '.'
          
          echo "--- Test 2: Commutative Equivalence ---"
          curl -s -X POST http://localhost:8085/api/v1/bpf/semantic/analyze \
            -H "Content-Type: application/json" \
            -d '{"expression1": "tcp and port 80", "expression2": "port 80 and tcp"}' | jq '.'
          
          echo "--- Test 3: Exact Match ---"
          curl -s -X POST http://localhost:8085/api/v1/bpf/semantic/analyze \
            -H "Content-Type: application/json" \
            -d '{"expression1": "icmp", "expression2": "icmp"}' | jq '.'
          
          echo "--- Test 4: Different Protocols (should NOT be equivalent) ---"
          RESULT=$(curl -s -X POST http://localhost:8085/api/v1/bpf/semantic/analyze \
            -H "Content-Type: application/json" \
            -d '{"expression1": "tcp", "expression2": "udp"}')
          echo "$RESULT" | jq '.'
          
          # Verify different protocols are detected as NOT equivalent
          IS_MATCH=$(echo "$RESULT" | jq '.semanticMatch')
          if [ "$IS_MATCH" = "true" ]; then
            echo "ERROR: TCP and UDP should NOT be semantically equivalent!"
            exit 1
          fi
          
          echo "=== All Semantic Tests Passed ==="
